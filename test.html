<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFF Flip</title>
    <script>
        const cities = [
            'Sektor A',
            'Sektor B',
            'Sektor C',
            'Sektor D',
            'Feldkirch',
            'Bellinzona',
            'Biel',
            'Bern',
            'Brig',
            'Basel',
            'Buchs SG',
            'Chur',
            'Chiasso',
            'Arth-Goldau',
            'Genève',
            'Göschenen',
            'Interlaken',
            'Lugano',
            'Locarno',
            'Lausanne',
            'Zagreb',
            'Olten',
            'Romanshorn',
            'Rorschach',
            'St. Gallen',
            'Schaffhausen',
            'Konstanz',
            'Winterthur',
            'Amsterdam',
            'Ancona',
            'Praha',
            'Bruxelles',
            'Budapest',
            'Livorno',
            'Genova',
            'Graz',
            'Hamburg',
            'Innsbruck',
            'Klagenfurt',
            'Leipzig Desden Praha',
            'Milano',
            'München',
            'Napoli',
            'Nürnberg',
            'Berlin',
            'Paris',
            'Roma',
            'La Spezia',
            'Venezia',
            'Ventimiglia',
            'Wien',
            'Oesterreich',
            'Deutschland',
            'France',
            'Italia',
            'Singen',
            'Ausland',
            'Nicht einsteigen',
            'Reservierte Wagen',
            'Beachten',
            'Stuttgart',
            'Vide'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                const grammar = '#JSGF V1.0; grammar cities; public <city> = ' + cities.join(' | ') + ' ;';
                //const speechRecognitionList = new SpeechGrammarList();
                //speechRecognitionList.addFromString(grammar, 1);
                //recognition.grammars = speechRecognitionList;
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'fr-CH';

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase();
                    console.debug("speech recognition result:", transcript);
                    const cityIndex = cities.findIndex(city => transcript.includes(city.toLowerCase()));
                    if (cityIndex !== -1) {
                        document.getElementById('citySelect').value = cityIndex;
                        moveToPanelByCity();
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                };

                const pttButton = document.getElementById('pttButton');
                pttButton.addEventListener('pointerdown', () => {
                    recognition.start();
                    pttButton.style.backgroundColor = 'red';
                });
                pttButton.addEventListener('pointerup', () => {
                    recognition.stop();
                    pttButton.style.backgroundColor = '';
                });
                pttButton.addEventListener('pointerleave', () => {
                    recognition.stop();
                    pttButton.style.backgroundColor = '';
                });
                pttButton.addEventListener("touchstart", (event) => {
                    event.preventDefault();
                });
            } else {
                document.getElementById('responseMessage').textContent = 'Speech recognition not supported in this browser.';
            }
        });
    </script>
</head>

<body>
    <div class="container">
        <h1>CFF Flip</h1>

        <label for="citySelect">Select a city:</label>
        <select id="citySelect" onchange="moveToPanelByCity()">
            <!-- Options will be populated by JavaScript -->
        </select>
        <button id="pttButton">Push to Talk</button>

        <h2>Actions</h2>
        <button onclick="calibrate()">Calibrate</button>
        <button onclick="stopServo()">Stop Servo</button>
        <button onclick="getDebug()">Get debug</button>
        <button onclick="getCurrentPanel()">Get Current Panel</button>

        <h2>Move to Specific Panel</h2>
        <input type="number" id="moveToPanelInput" placeholder="Enter Panel Number" value="0">
        <button onclick="moveToPanel()">Move to Panel</button>

        <h2>Advance Panels</h2>
        <input type="number" id="advancePanelsInput" placeholder="Enter Count" value="5">
        <button onclick="advancePanels()">Advance Panels</button>


        <p id="responseMessage"></p>
    </div>

    <script>
        const API_BASE_URL = 'http://192.168.0.222';

        // Populate the select element with city options
        const citySelect = document.getElementById('citySelect');
        cities.forEach((city, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = index + " - " + city;
            citySelect.appendChild(option);
        });

        async function apiRequest(endpoint, method = 'GET', params = {}) {
            let url = `${API_BASE_URL}${endpoint}`;

            if (method === 'GET' && Object.keys(params).length) {
                url += '?' + new URLSearchParams(params);
            }

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            };

            if (method === 'POST') {
                options.body = new URLSearchParams(params);
            }

            try {
                const response = await fetch(url, options);
                const data = await response.text();
                document.getElementById('responseMessage').textContent = `Response: ${data}`;
                return data;
            } catch (error) {
                document.getElementById('responseMessage').textContent = `Error: ${error.message}`;
                console.error(error);
            }
        }

        function updateCitySelect(panelIndex) {
            document.getElementById('citySelect').value = panelIndex;
        }

        function moveToPanelByCity() {
            const panelIndex = parseInt(document.getElementById('citySelect').value);
            apiRequest('/moveToPanel', 'POST', { panel: panelIndex });
        }

        function getCurrentPanel() {
            apiRequest('/getCurrentPanel').then(data => {
                let panelIndex = parseInt(data);
                updateCitySelect(panelIndex);
            });
        }

        function moveToPanel() {
            const panelIndex = parseInt(document.getElementById('moveToPanelInput').value);
            if (!panelIndex) {
                alert('Please enter a panel number.');
                return;
            }
            apiRequest('/moveToPanel', 'POST', { panel: panelIndex });
            updateCitySelect(panelIndex);
        }

        function advancePanels() {
            const nbPanels = parseInt(document.getElementById('advancePanelsInput').value);
            if (!nbPanels) {
                alert('Please enter a count.');
                return;
            }
            apiRequest('/advancePanels', 'POST', { count: nbPanels });
            const currentPanel = parseInt(document.getElementById('citySelect').value);
            const panelIndex = (currentPanel + nbPanels) % cities.length;
            console.debug(document.getElementById('citySelect').value, nbPanels, panelIndex, cities[panelIndex]);
            updateCitySelect(panelIndex);
        }

        function calibrate() {
            apiRequest('/calibrate');
        }

        function stopServo() {
            apiRequest('/stop');
        }

        function getDebug() {
            apiRequest('/getDebug');
        }
    </script>
</body>

</html>